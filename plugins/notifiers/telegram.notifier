# ============================================================================
# Autoclean Notifier Plugin: Telegram Bot
# ============================================================================
# Sends notifications via Telegram Bot API
# Requires creating a bot with @BotFather and getting the chat_id
# ============================================================================

# === METADATA ===
NOTIFIER_NAME="Telegram"
NOTIFIER_CODE="telegram"
NOTIFIER_DESCRIPTION="Notifications via Telegram Bot API"
NOTIFIER_DEPS="curl"

# === CONFIGURATION ===
declare -A NOTIFIER_FIELDS=(
    ["NOTIFIER_TELEGRAM_BOT_TOKEN"]="Bot token (from @BotFather)"
    ["NOTIFIER_TELEGRAM_CHAT_ID"]="Chat ID (user, group, or channel)"
)

# === FUNCTIONS ===

notifier_check_deps() {
    command -v curl &>/dev/null
}

notifier_is_configured() {
    [[ -n "$NOTIFIER_TELEGRAM_BOT_TOKEN" && -n "$NOTIFIER_TELEGRAM_CHAT_ID" ]]
}

notifier_send() {
    local title="$1"
    local message="$2"
    local severity="${3:-info}"

    # Add emoji based on severity
    local emoji=""
    case "$severity" in
        critical) emoji="ðŸš¨" ;;
        error)    emoji="âŒ" ;;
        warning)  emoji="âš ï¸" ;;
        success)  emoji="âœ…" ;;
        *)        emoji="â„¹ï¸" ;;
    esac

    # Build message (without Markdown to avoid issues with special characters)
    local full_message="${emoji} ${title}

${message}"

    # Send via Telegram API (without parse_mode for plain text with emojis)
    local response
    response=$(curl -s -X POST \
        "https://api.telegram.org/bot${NOTIFIER_TELEGRAM_BOT_TOKEN}/sendMessage" \
        -d chat_id="${NOTIFIER_TELEGRAM_CHAT_ID}" \
        -d text="${full_message}" \
        --connect-timeout 10 \
        --max-time 30 \
        2>/dev/null)

    # Verify response
    if echo "$response" | grep -q '"ok":true'; then
        return 0
    else
        return 1
    fi
}

notifier_test() {
    local hostname
    hostname=$(hostname 2>/dev/null || echo "unknown")
    notifier_send "Autoclean Test" "Telegram notifications configured correctly!

Host: ${hostname}
Date: $(date '+%Y-%m-%d %H:%M:%S')" "success"
}

notifier_help() {
    cat << 'HELP_EOF'
================================================================================
                    TELEGRAM NOTIFICATIONS - SETUP GUIDE
================================================================================

STEP 1: Create a Telegram Bot
------------------------------
1. Open Telegram and search for @BotFather
2. Send /newbot command
3. Follow the prompts to name your bot
4. Copy the bot token (looks like: 123456789:ABCdefGHI...)

STEP 2: Get your Chat ID
------------------------
Option A - For personal notifications:
  1. Search for @userinfobot on Telegram
  2. Start the bot and it will show your user ID
  3. Use this number as your Chat ID

Option B - For group notifications:
  1. Add your bot to the group
  2. Send a message in the group
  3. Visit: https://api.telegram.org/bot<TOKEN>/getUpdates
  4. Look for "chat":{"id":-XXXXXXX} (negative number for groups)

Option C - For channel notifications:
  1. Add your bot as admin to the channel
  2. The Chat ID is @channelname or the channel's numeric ID

STEP 3: Configure in Autoclean
------------------------------
Enter the values in the configuration menu:
  - Bot Token: The token from @BotFather
  - Chat ID: Your user/group/channel ID

TESTING:
--------
Use the "Test" option to verify your configuration works.

TROUBLESHOOTING:
----------------
- "Unauthorized": Check your bot token is correct
- "Chat not found": Make sure you've started a conversation with the bot
- For groups: Ensure the bot is a member of the group
- For channels: Ensure the bot is an admin

================================================================================
HELP_EOF
}
